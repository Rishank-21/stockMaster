<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouses - StockMaster</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans+Text:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/css/material.css">
    <link rel="stylesheet" href="/css/components.css">
</head>

<body>
    <nav class="md-navigation-drawer">
        <a href="/dashboard.html" class="md-nav-item"><span
                class="material-icons">dashboard</span><span>Dashboard</span></a>
        <a href="/products.html" class="md-nav-item"><span
                class="material-icons">inventory_2</span><span>Products</span></a>
        <a href="/receipts.html" class="md-nav-item"><span
                class="material-icons">local_shipping</span><span>Receipts</span></a>
        <a href="/deliveries.html" class="md-nav-item"><span
                class="material-icons">send</span><span>Deliveries</span></a>
        <a href="/transfers.html" class="md-nav-item"><span
                class="material-icons">swap_horiz</span><span>Transfers</span></a>
        <a href="/adjustments.html" class="md-nav-item"><span
                class="material-icons">tune</span><span>Adjustments</span></a>
        <a href="/history.html" class="md-nav-item"><span class="material-icons">history</span><span>History</span></a>
        <a href="/suppliers.html" class="md-nav-item"><span
                class="material-icons">store</span><span>Suppliers</span></a>
        <a href="/warehouses.html" class="md-nav-item active"><span
                class="material-icons">warehouse</span><span>Warehouses</span></a>
        <a href="/profile.html" class="md-nav-item"><span
                class="material-icons">person</span><span>My Profile</span></a>
        <div style="margin-top: auto; padding: 24px;"><button onclick="logout()"
                class="md-button md-button-outlined full-width"><span
                    class="material-icons">logout</span>Logout</button></div>
    </nav>

    <div class="main-content">
        <div class="md-top-app-bar">
            <h1 class="md-top-app-bar-title">Warehouse Management</h1>
        </div>

        <div class="content-container">
            <div class="md-card">
                <div class="md-card-header">
                    <h2 class="md-card-title">Warehouses & Locations</h2>
                </div>
                <div class="md-table-container">
                    <table class="md-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Location</th>
                                <th>Capacity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="warehousesTable">
                            <tr>
                                <td colspan="5" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <button class="md-fab" onclick="openWarehouseDialog()"><span class="material-icons">add</span></button>

    <!-- Add/Edit Warehouse Dialog -->
    <div id="warehouseDialog" class="md-dialog-overlay">
        <div class="md-dialog">
            <h2 class="md-dialog-title" id="dialogTitle">Add Warehouse</h2>
            <div class="md-dialog-content">
                <form id="warehouseForm">
                    <input type="hidden" id="warehouseId">
                    <div class="md-text-field">
                        <input type="text" id="name" placeholder=" " required>
                        <label>Warehouse Name</label>
                    </div>
                    <div class="md-text-field">
                        <input type="text" id="location" placeholder=" " required>
                        <label>Location/Address</label>
                    </div>
                    <div class="md-text-field">
                        <input type="number" id="capacity" placeholder=" " min="0">
                        <label>Capacity (optional)</label>
                    </div>
                </form>
            </div>
            <div class="md-dialog-actions">
                <button class="md-button md-button-text" onclick="closeWarehouseDialog()">Cancel</button>
                <button class="md-button md-button-filled" onclick="saveWarehouse()">Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Dialog -->
    <div id="deleteDialog" class="md-dialog-overlay">
        <div class="md-dialog">
            <h2 class="md-dialog-title">Delete Warehouse</h2>
            <div class="md-dialog-content">
                <p>Are you sure you want to delete this warehouse? This action cannot be undone.</p>
            </div>
            <div class="md-dialog-actions">
                <button class="md-button md-button-text" onclick="closeDeleteDialog()">Cancel</button>
                <button class="md-button md-button-filled" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <div id="loader">
        <div class="spinner"></div>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        checkAuth();

        let warehouses = [];
        let deleteId = null;

        async function loadWarehouses() {
            try {
                showLoading();
                warehouses = await api.getWarehouses();
                const tbody = document.getElementById('warehousesTable');
                
                if (warehouses.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">No warehouses found. Click + to add one.</td></tr>';
                } else {
                    tbody.innerHTML = warehouses.map(w => `
                        <tr>
                            <td>${w.id}</td>
                            <td>${w.name}</td>
                            <td>${w.location || '-'}</td>
                            <td>${w.capacity || '-'}</td>
                            <td>
                                <button class="md-button md-button-text" onclick="editWarehouse(${w.id})">
                                    <span class="material-icons">edit</span>
                                    Edit
                                </button>
                                <button class="md-button md-button-text" onclick="deleteWarehouse(${w.id})">
                                    <span class="material-icons">delete</span>
                                    Delete
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                showToast('Failed to load warehouses: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function openWarehouseDialog() {
            document.getElementById('dialogTitle').textContent = 'Add Warehouse';
            document.getElementById('warehouseId').value = '';
            document.getElementById('warehouseForm').reset();
            document.getElementById('warehouseDialog').classList.add('show');
        }

        function closeWarehouseDialog() {
            document.getElementById('warehouseDialog').classList.remove('show');
            document.getElementById('warehouseForm').reset();
        }

        function editWarehouse(id) {
            const warehouse = warehouses.find(w => w.id === id);
            if (!warehouse) return;

            document.getElementById('dialogTitle').textContent = 'Edit Warehouse';
            document.getElementById('warehouseId').value = warehouse.id;
            document.getElementById('name').value = warehouse.name;
            document.getElementById('location').value = warehouse.location || '';
            document.getElementById('capacity').value = warehouse.capacity || '';
            document.getElementById('warehouseDialog').classList.add('show');
        }

        async function saveWarehouse() {
            const id = document.getElementById('warehouseId').value;
            const warehouseData = {
                name: document.getElementById('name').value,
                location: document.getElementById('location').value,
                capacity: document.getElementById('capacity').value ? parseInt(document.getElementById('capacity').value) : null
            };

            if (id) {
                warehouseData.id = parseInt(id);
            }

            try {
                showLoading();
                await api.createWarehouse(warehouseData);
                showToast(id ? 'Warehouse updated!' : 'Warehouse created!', 'success');
                closeWarehouseDialog();
                loadWarehouses();
            } catch (error) {
                showToast('Failed to save warehouse: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function deleteWarehouse(id) {
            deleteId = id;
            document.getElementById('deleteDialog').classList.add('show');
        }

        function closeDeleteDialog() {
            document.getElementById('deleteDialog').classList.remove('show');
            deleteId = null;
        }

        async function confirmDelete() {
            if (!deleteId) return;

            try {
                showLoading();
                await api.deleteWarehouse(deleteId);
                showToast('Warehouse deleted!', 'success');
                closeDeleteDialog();
                loadWarehouses();
            } catch (error) {
                showToast('Failed to delete warehouse: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        loadWarehouses();
    </script>
</body>

</html>
