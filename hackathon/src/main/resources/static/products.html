<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products - StockMaster</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans+Text:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/css/material.css">
    <link rel="stylesheet" href="/css/components.css">
</head>

<body>
    <nav class="md-navigation-drawer">
        <a href="/dashboard.html" class="md-nav-item"><span
                class="material-icons">dashboard</span><span>Dashboard</span></a>
        <a href="/products.html" class="md-nav-item active"><span
                class="material-icons">inventory_2</span><span>Products</span></a>
        <a href="/receipts.html" class="md-nav-item"><span
                class="material-icons">local_shipping</span><span>Receipts</span></a>
        <a href="/deliveries.html" class="md-nav-item"><span
                class="material-icons">send</span><span>Deliveries</span></a>
        <a href="/transfers.html" class="md-nav-item"><span
                class="material-icons">swap_horiz</span><span>Transfers</span></a>
        <a href="/adjustments.html" class="md-nav-item"><span
                class="material-icons">tune</span><span>Adjustments</span></a>
        <a href="/history.html" class="md-nav-item"><span class="material-icons">history</span><span>History</span></a>
        <a href="/suppliers.html" class="md-nav-item"><span
                class="material-icons">store</span><span>Suppliers</span></a>
        <a href="/warehouses.html" class="md-nav-item"><span
                class="material-icons">warehouse</span><span>Warehouses</span></a>
        <a href="/profile.html" class="md-nav-item"><span
                class="material-icons">person</span><span>My Profile</span></a>
        <div style="margin-top: auto; padding: 24px;"><button onclick="logout()"
                class="md-button md-button-outlined full-width"><span
                    class="material-icons">logout</span>Logout</button></div>
    </nav>

    <div class="main-content">
        <div class="md-top-app-bar">
            <h1 class="md-top-app-bar-title">Products</h1>
        </div>

        <div class="content-container">
            <!-- Search and Filters -->
            <div class="md-card mb-24">
                <h3 class="title-medium mb-16">Search Products</h3>
                <div class="md-grid md-grid-3">
                    <div class="md-text-field">
                        <input type="text" id="searchSKU" placeholder=" ">
                        <label>Search by SKU</label>
                    </div>
                    <div class="md-text-field">
                        <input type="text" id="searchName" placeholder=" ">
                        <label>Search by Name</label>
                    </div>
                    <div class="md-text-field">
                        <input type="text" id="searchCategory" placeholder=" ">
                        <label>Filter by Category</label>
                    </div>
                </div>
                <button class="md-button md-button-filled" onclick="searchProducts()">
                    <span class="material-icons">search</span>
                    Search
                </button>
                <button class="md-button md-button-outlined" onclick="clearSearch()">
                    <span class="material-icons">clear</span>
                    Clear
                </button>
            </div>

            <!-- Products Table -->
            <div class="md-card mb-24">
                <div class="md-card-header">
                    <h2 class="md-card-title">Products</h2>
                </div>
                <div class="md-table-container">
                    <table class="md-table">
                        <thead>
                            <tr>
                                <th>SKU</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Unit</th>
                                <th>Price</th>
                                <th>Total Stock</th>
                                <th>Min Stock</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTable">
                            <tr>
                                <td colspan="8" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Stock by Location -->
            <div class="md-card">
                <div class="md-card-header">
                    <h2 class="md-card-title">Stock Availability by Location</h2>
                </div>
                <div class="md-table-container">
                    <table class="md-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Warehouse</th>
                                <th>Quantity</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="stockByLocationTable">
                            <tr>
                                <td colspan="4" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <button class="md-fab" onclick="openProductDialog()"><span class="material-icons">add</span></button>

    <div id="productDialog" class="md-dialog-overlay">
        <div class="md-dialog">
            <h2 class="md-dialog-title" id="dialogTitle">Add Product</h2>
            <div class="md-dialog-content">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="md-text-field"><input type="text" id="name" placeholder=" " required><label>Name</label>
                    </div>
                    <div class="md-text-field"><input type="text" id="sku" placeholder=" " required><label>SKU</label>
                    </div>
                    <div class="md-text-field"><input type="text" id="category" placeholder=" "
                            required><label>Category</label></div>
                    <div class="md-text-field"><input type="text" id="unitOfMeasure" placeholder=" "
                            required><label>Unit (kg/units)</label></div>
                    <div class="md-text-field"><input type="number" id="price" placeholder=" " step="0.01"
                            required><label>Price</label></div>
                    <div class="md-text-field"><input type="number" id="minStockLevel" placeholder=" "
                            required><label>Min Stock Level</label></div>
                    <div class="md-text-field"><input type="number" id="reorderPoint" placeholder=" "
                            min="0"><label>Reorder Point (optional)</label></div>
                    <div class="md-text-field"><input type="number" id="reorderQuantity" placeholder=" "
                            min="0"><label>Reorder Quantity (optional)</label></div>
                </form>
            </div>
            <div class="md-dialog-actions">
                <button class="md-button md-button-text" onclick="closeProductDialog()">Cancel</button>
                <button class="md-button md-button-filled" onclick="saveProduct()">Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Dialog -->
    <div id="deleteDialog" class="md-dialog-overlay">
        <div class="md-dialog">
            <h2 class="md-dialog-title">Delete Product</h2>
            <div class="md-dialog-content">
                <p>Are you sure you want to delete this product? This action cannot be undone.</p>
            </div>
            <div class="md-dialog-actions">
                <button class="md-button md-button-text" onclick="closeDeleteDialog()">Cancel</button>
                <button class="md-button md-button-filled" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Product Detail Dialog -->
    <div id="productDetailDialog" class="md-dialog-overlay">
        <div class="md-dialog">
            <h2 class="md-dialog-title">Product Details</h2>
            <div class="md-dialog-content" id="productDetailContent"></div>
            <div class="md-dialog-actions">
                <button class="md-button md-button-filled" onclick="closeProductDetail()">Close</button>
            </div>
        </div>
    </div>

    <div id="loader">
        <div class="spinner"></div>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        checkAuth();

        let allProducts = [];
        let deleteId = null;
        let stockInventory = [];

        async function loadProducts() {
            try {
                showLoading();
                const [products, inventory] = await Promise.all([
                    api.getProducts(),
                    api.getInventory()
                ]);
                allProducts = products;
                stockInventory = inventory;
                displayProducts(allProducts);
                await loadStockByLocation();
            } catch (error) {
                showToast('Failed to load products: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function getTotalStock(productId) {
            const total = stockInventory
                .filter(item => item.product.id === productId)
                .reduce((sum, item) => sum + (item.quantity || 0), 0);
            return total;
        }

        function displayProducts(products) {
            const tbody = document.getElementById('productsTable');
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No products found</td></tr>';
            } else {
                tbody.innerHTML = products.map(p => {
                    const totalStock = getTotalStock(p.id);
                    const stockColor = totalStock <= 0 ? 'var(--md-sys-color-error)' :
                        totalStock < (p.minStockLevel || 0) ? '#FF9800' : 'var(--md-sys-color-on-surface)';
                    return `
                    <tr onclick="showProductDetail(${p.id})" style="cursor: pointer;">
                        <td>${p.sku}</td>
                        <td>${p.name}</td>
                        <td>${p.category}</td>
                        <td>${p.unitOfMeasure}</td>
                        <td>$${p.price}</td>
                        <td style="color: ${stockColor}; font-weight: 500;">${totalStock}</td>
                        <td>${p.minStockLevel || '-'}</td>
                        <td>
                            <button class="md-button md-button-text" onclick="event.stopPropagation(); editProduct(${p.id})">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="md-button md-button-text" onclick="event.stopPropagation(); deleteProduct(${p.id})">
                                <span class="material-icons">delete</span>
                            </button>
                        </td>
                    </tr>
                `}).join('');
            }
        }

        function showProductDetail(productId) {
            const product = allProducts.find(p => p.id === productId);
            if (!product) return;

            const totalStock = getTotalStock(productId);
            const locations = stockInventory.filter(item => item.product.id === productId);
            
            const locationsHTML = locations.length > 0 ? 
                locations.map(loc => {
                    const statusColor = loc.quantity <= 0 ? 'var(--md-sys-color-error)' :
                        loc.quantity < (product.minStockLevel || 0) ? '#FF9800' : 'var(--md-sys-color-success)';
                    return `
                        <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid var(--md-sys-color-outline-variant);">
                            <div class="body-medium">${loc.warehouse.name}</div>
                            <div class="title-medium" style="color: ${statusColor}; font-weight: 700;">${loc.quantity} ${product.unitOfMeasure}</div>
                        </div>
                    `;
                }).join('') : 
                '<div class="body-medium" style="text-align: center; padding: 16px; color: var(--md-sys-color-on-surface-variant);">No stock in any warehouse</div>';

            const totalStockColor = totalStock <= 0 ? 'var(--md-sys-color-error)' :
                totalStock < (product.minStockLevel || 0) ? '#FF9800' : 'var(--md-sys-color-success)';

            document.getElementById('productDetailContent').innerHTML = `
                <div style="display: grid; gap: 16px;">
                    <div><div class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">Product Name</div><div class="title-medium">${product.name}</div></div>
                    <div><div class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">SKU</div><div class="title-medium">${product.sku}</div></div>
                    <div><div class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">Category</div><div class="title-medium">${product.category}</div></div>
                    <div><div class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">Unit of Measure</div><div class="title-medium">${product.unitOfMeasure}</div></div>
                    <div><div class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">Price</div><div class="title-medium">$${product.price}</div></div>
                    <div><div class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">Total Stock</div><div class="title-large" style="color: ${totalStockColor}; font-weight: 700;">${totalStock} ${product.unitOfMeasure}</div></div>
                    <div><div class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">Min Stock Level</div><div class="title-medium">${product.minStockLevel || '-'}</div></div>
                    <div><div class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">Reorder Point</div><div class="title-medium">${product.reorderPoint || '-'}</div></div>
                    <div><div class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">Reorder Quantity</div><div class="title-medium">${product.reorderQuantity || '-'}</div></div>
                    <div style="margin-top: 16px;">
                        <div class="title-medium" style="margin-bottom: 12px;">Stock by Location</div>
                        <div style="border: 1px solid var(--md-sys-color-outline-variant); border-radius: 8px; overflow: hidden;">
                            ${locationsHTML}
                        </div>
                    </div>
                </div>`;
            document.getElementById('productDetailDialog').classList.add('show');
        }

        function closeProductDetail() {
            document.getElementById('productDetailDialog').classList.remove('show');
        }

        async function loadStockByLocation() {
            try {
                const inventory = await api.getInventory();
                const tbody = document.getElementById('stockByLocationTable');
                
                if (inventory.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center">No stock data available</td></tr>';
                } else {
                    tbody.innerHTML = inventory.map(item => {
                        const status = item.quantity <= 0 ? 'Out of Stock' :
                            item.quantity < (item.product.minStockLevel || 0) ? 'Low Stock' : 'In Stock';
                        const statusColor = item.quantity <= 0 ? 'var(--md-sys-color-error)' :
                            item.quantity < (item.product.minStockLevel || 0) ? '#FF9800' : 'var(--md-sys-color-success)';
                        return `
                            <tr>
                                <td>${item.product.name} (${item.product.sku})</td>
                                <td>${item.warehouse.name}</td>
                                <td>${item.quantity} ${item.product.unitOfMeasure}</td>
                                <td><span style="color: ${statusColor}; font-weight: 500;">${status}</span></td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Failed to load stock by location:', error);
            }
        }

        function searchProducts() {
            const sku = document.getElementById('searchSKU').value.toLowerCase();
            const name = document.getElementById('searchName').value.toLowerCase();
            const category = document.getElementById('searchCategory').value.toLowerCase();

            const filtered = allProducts.filter(p => {
                return (!sku || p.sku.toLowerCase().includes(sku)) &&
                    (!name || p.name.toLowerCase().includes(name)) &&
                    (!category || p.category.toLowerCase().includes(category));
            });

            displayProducts(filtered);
        }

        function clearSearch() {
            document.getElementById('searchSKU').value = '';
            document.getElementById('searchName').value = '';
            document.getElementById('searchCategory').value = '';
            displayProducts(allProducts);
        }

        function openProductDialog() {
            document.getElementById('dialogTitle').textContent = 'Add Product';
            document.getElementById('productId').value = '';
            document.getElementById('productForm').reset();
            document.getElementById('productDialog').classList.add('show');
        }

        function closeProductDialog() {
            document.getElementById('productDialog').classList.remove('show');
            document.getElementById('productForm').reset();
        }

        function editProduct(id) {
            const product = allProducts.find(p => p.id === id);
            if (!product) return;

            document.getElementById('dialogTitle').textContent = 'Edit Product';
            document.getElementById('productId').value = product.id;
            document.getElementById('name').value = product.name;
            document.getElementById('sku').value = product.sku;
            document.getElementById('category').value = product.category;
            document.getElementById('unitOfMeasure').value = product.unitOfMeasure;
            document.getElementById('price').value = product.price;
            document.getElementById('minStockLevel').value = product.minStockLevel || '';
            document.getElementById('reorderPoint').value = product.reorderPoint || '';
            document.getElementById('reorderQuantity').value = product.reorderQuantity || '';
            document.getElementById('productDialog').classList.add('show');
        }

        async function saveProduct() {
            const id = document.getElementById('productId').value;
            const product = {
                name: document.getElementById('name').value,
                sku: document.getElementById('sku').value,
                category: document.getElementById('category').value,
                unitOfMeasure: document.getElementById('unitOfMeasure').value,
                price: parseFloat(document.getElementById('price').value),
                minStockLevel: parseInt(document.getElementById('minStockLevel').value) || null,
                reorderPoint: parseInt(document.getElementById('reorderPoint').value) || null,
                reorderQuantity: parseInt(document.getElementById('reorderQuantity').value) || null
            };

            try {
                showLoading();
                if (id) {
                    await api.updateProduct(id, product);
                    showToast('Product updated!', 'success');
                } else {
                    await api.createProduct(product);
                    showToast('Product created!', 'success');
                }
                closeProductDialog();
                loadProducts();
            } catch (error) {
                showToast('Failed to save product: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function deleteProduct(id) {
            deleteId = id;
            document.getElementById('deleteDialog').classList.add('show');
        }

        function closeDeleteDialog() {
            document.getElementById('deleteDialog').classList.remove('show');
            deleteId = null;
        }

        async function confirmDelete() {
            if (!deleteId) return;

            try {
                showLoading();
                await api.deleteProduct(deleteId);
                showToast('Product deleted!', 'success');
                closeDeleteDialog();
                loadProducts();
            } catch (error) {
                showToast('Failed to delete product: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        loadProducts();
    </script>
</body>

</html>