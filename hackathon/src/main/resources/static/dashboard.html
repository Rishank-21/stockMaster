<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - StockMaster</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans+Text:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/css/material.css">
    <link rel="stylesheet" href="/css/components.css">
</head>

<body>
    <!-- Navigation Drawer -->
    <nav class="md-navigation-drawer">
        <a href="/dashboard.html" class="md-nav-item active">
            <span class="material-icons">dashboard</span>
            <span>Dashboard</span>
        </a>
        <a href="/products.html" class="md-nav-item">
            <span class="material-icons">inventory_2</span>
            <span>Products</span>
        </a>
        <a href="/receipts.html" class="md-nav-item">
            <span class="material-icons">local_shipping</span>
            <span>Receipts</span>
        </a>
        <a href="/deliveries.html" class="md-nav-item">
            <span class="material-icons">send</span>
            <span>Deliveries</span>
        </a>
        <a href="/transfers.html" class="md-nav-item">
            <span class="material-icons">swap_horiz</span>
            <span>Transfers</span>
        </a>
        <a href="/adjustments.html" class="md-nav-item">
            <span class="material-icons">tune</span>
            <span>Adjustments</span>
        </a>
        <a href="/history.html" class="md-nav-item">
            <span class="material-icons">history</span>
            <span>History</span>
        </a>
        <a href="/suppliers.html" class="md-nav-item">
            <span class="material-icons">store</span>
            <span>Suppliers</span>
        </a>
        <a href="/warehouses.html" class="md-nav-item">
            <span class="material-icons">warehouse</span>
            <span>Warehouses</span>
        </a>
        <a href="/profile.html" class="md-nav-item">
            <span class="material-icons">person</span>
            <span>My Profile</span>
        </a>
        <div style="margin-top: auto; padding: 24px;">
            <button onclick="logout()" class="md-button md-button-outlined full-width">
                <span class="material-icons">logout</span>
                Logout
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div class="md-top-app-bar">
            <h1 class="md-top-app-bar-title">Dashboard</h1>
            <span id="userDisplay" class="body-medium"></span>
        </div>

        <div class="content-container">
            <!-- Filters -->
            <div class="md-card mb-24">
                <h3 class="title-medium mb-16">Dashboard Filters</h3>
                <div class="md-grid md-grid-3">
                    <div class="md-text-field">
                        <select id="filterType">
                            <option value="">All Types</option>
                            <option value="RECEIPT">Receipts</option>
                            <option value="DELIVERY">Deliveries</option>
                            <option value="TRANSFER">Internal Transfers</option>
                            <option value="ADJUSTMENT">Adjustments</option>
                        </select>
                        <label>Document Type</label>
                    </div>
                    <div class="md-text-field">
                        <select id="filterStatus">
                            <option value="">All Status</option>
                            <option value="DRAFT">Draft</option>
                            <option value="WAITING">Waiting</option>
                            <option value="READY">Ready</option>
                            <option value="DONE">Done</option>
                            <option value="PENDING">Pending</option>
                            <option value="CANCELED">Canceled</option>
                        </select>
                        <label>Status</label>
                    </div>
                    <div class="md-text-field">
                        <select id="filterWarehouse">
                            <option value="">All Warehouses</option>
                        </select>
                        <label>Warehouse</label>
                    </div>
                </div>
                <button class="md-button md-button-filled" onclick="applyDashboardFilters()">
                    <span class="material-icons">filter_list</span>
                    Apply Filters
                </button>
                <button class="md-button md-button-outlined" onclick="clearDashboardFilters()">
                    <span class="material-icons">clear</span>
                    Clear
                </button>
            </div>

            <!-- KPI Cards -->
            <div class="md-grid md-grid-5 mb-24">
                <div class="md-card">
                    <div class="md-card-header">
                        <div class="title-medium">Total Products</div>
                    </div>
                    <div style="font-size: 48px; font-weight: 700; color: var(--md-sys-color-primary);"
                        id="totalProducts">0</div>
                </div>
                <div class="md-card">
                    <div class="md-card-header">
                        <div class="title-medium">Low Stock Items</div>
                    </div>
                    <div style="font-size: 48px; font-weight: 700; color: var(--md-sys-color-error);" id="lowStock">0
                    </div>
                </div>
                <div class="md-card">
                    <div class="md-card-header">
                        <div class="title-medium">Pending Receipts</div>
                    </div>
                    <div style="font-size: 48px; font-weight: 700; color: var(--md-sys-color-tertiary);"
                        id="pendingReceipts">0</div>
                </div>
                <div class="md-card">
                    <div class="md-card-header">
                        <div class="title-medium">Pending Deliveries</div>
                    </div>
                    <div style="font-size: 48px; font-weight: 700; color: var(--md-sys-color-secondary);"
                        id="pendingDeliveries">0</div>
                </div>
                <div class="md-card">
                    <div class="md-card-header">
                        <div class="title-medium">Transfers Scheduled</div>
                    </div>
                    <div style="font-size: 48px; font-weight: 700; color: #9C27B0;"
                        id="transfersScheduled">0</div>
                </div>
            </div>

            <!-- Low Stock Alerts -->
            <div class="md-card mb-24">
                <div class="md-card-header">
                    <h2 class="md-card-title">Low Stock Alerts</h2>
                </div>
                <div class="md-table-container">
                    <table class="md-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Warehouse</th>
                                <th>Current Stock</th>
                                <th>Min Level</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="lowStockTable">
                            <tr>
                                <td colspan="5" class="text-center">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="loader">
        <div class="spinner"></div>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script>
        checkAuth();

        const username = localStorage.getItem('username');
        document.getElementById('userDisplay').textContent = username || 'User';

        async function loadWarehouses() {
            try {
                const warehouses = await api.getWarehouses();
                const select = document.getElementById('filterWarehouse');
                select.innerHTML = '<option value="">All Warehouses</option>' +
                    warehouses.map(w => `<option value="${w.id}">${w.name}</option>`).join('');
            } catch (error) {
                console.error('Failed to load warehouses:', error);
            }
        }

        async function loadDashboard(filters = {}) {
            try {
                showLoading();

                // Load KPIs
                const stats = await api.getDashboardStats();
                document.getElementById('totalProducts').textContent = stats.totalProducts || 0;
                document.getElementById('lowStock').textContent = stats.lowStockItems || 0;
                document.getElementById('pendingReceipts').textContent = stats.pendingReceipts || 0;
                document.getElementById('pendingDeliveries').textContent = stats.pendingDeliveries || 0;
                document.getElementById('transfersScheduled').textContent = stats.transfersScheduled || 0;

                // Load low stock items
                const lowStockItems = await api.getLowStockItems();
                const tbody = document.getElementById('lowStockTable');

                if (lowStockItems.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center">No low stock items</td></tr>';
                } else {
                    tbody.innerHTML = lowStockItems.map(item => `
                        <tr>
                            <td>${item.product.name}</td>
                            <td>${item.warehouse.name}</td>
                            <td>${item.quantity}</td>
                            <td>${item.product.minStockLevel}</td>
                            <td>
                                <a href="/receipts.html?productId=${item.product.id}" class="md-button md-button-text">
                                    <span class="material-icons">add</span>
                                    Restock
                                </a>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                showToast('Failed to load dashboard: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        function applyDashboardFilters() {
            const filters = {
                type: document.getElementById('filterType').value || undefined,
                status: document.getElementById('filterStatus').value || undefined,
                warehouseId: document.getElementById('filterWarehouse').value || undefined
            };
            loadDashboard(filters);
            showToast('Filters applied', 'success');
        }

        function clearDashboardFilters() {
            document.getElementById('filterType').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterWarehouse').value = '';
            loadDashboard();
            showToast('Filters cleared', 'success');
        }

        loadWarehouses();
        loadDashboard();
    </script>
</body>

</html>